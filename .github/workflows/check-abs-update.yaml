---
name: Check ABS Update

"on":
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check:
    name: Check for ABS Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get current ABS version
        id: current
        run: |
          VERSION=$(grep 'ABS_VERSION=' Dockerfile | head -1 | cut -d= -f2)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Get latest ABS release
        id: latest
        run: |
          LATEST=$(curl -s https://api.github.com/repos/advplyr/audiobookshelf/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          echo "version=${LATEST}" >> $GITHUB_OUTPUT

      - name: Check if update needed
        id: check
        run: |
          if [ "${{ steps.current.outputs.version }}" != "${{ steps.latest.outputs.version }}" ]; then
            echo "update=true" >> $GITHUB_OUTPUT
          else
            echo "update=false" >> $GITHUB_OUTPUT
            echo "Already on latest version: ${{ steps.current.outputs.version }}"
          fi

      - name: Create PR if update available
        if: steps.check.outputs.update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH="update-abs-${{ steps.latest.outputs.version }}"

          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "Branch $BRANCH already exists, skipping"
            exit 0
          fi

          git checkout -b "$BRANCH"

          # Update Dockerfile
          sed -i "s/ABS_VERSION=.*/ABS_VERSION=${{ steps.latest.outputs.version }}/" Dockerfile

          # Update build.yaml
          sed -i "s/ABS_VERSION:.*/ABS_VERSION: \"${{ steps.latest.outputs.version }}\"/" build.yaml

          git add Dockerfile build.yaml
          git commit -m "feat: Update Audiobookshelf to ${{ steps.latest.outputs.version }}"
          git push -u origin "$BRANCH"

          gh pr create \
            --title "feat: Update Audiobookshelf to ${{ steps.latest.outputs.version }}" \
            --body "Automated update to Audiobookshelf ${{ steps.latest.outputs.version }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
